{-# OPTIONS --no-import-sorts #-}
{-|
# Alexandrov Topology on the Poset X (Section 1.5, Definitions 1 & Proposition 1.2)

**Reference**: Belfiore & Bennequin (2022), Section 1.5
arXiv:2106.14587v3 [math.AT]

## Main Results:

**Definitions 1**: The (lower) Alexandrov topology on X
- Open sets: U open ⇔ (y ∈ U ∧ x ≤ y) ⇒ x ∈ U
- Basis: Principal ideals ↓α = {β | β ≤ α}

**Proposition 1.2**: Every presheaf of sets over CX can be extended to a sheaf
on X for the Alexandrov topology, uniquely up to unique isomorphism.

**Corollary**: Sh(X, Alexandrov) ≃ [CX^op, Sets]

## The Alexandrov Topology

From the paper:
> "The (lower) Alexandrov topology on X, is made by the subsets U of X such that
> (y ∈ U and x ≤ y) imply x ∈ U."

This is the **downward-closed** topology: if y is in an open set U, and x ≤ y
(meaning there's an arrow from y to x in the poset), then x must also be in U.

In terms of information flow (where arrows point opposite to ≤):
- U is open ⇔ U is **upward-closed** in the graph direction
- If information flows from x to y, and y ∈ U, then x ∈ U

### Geometric Interpretation:

For a DNN:
- Open sets represent "upstream regions" in the network
- If a layer y is in region U, all layers that feed into y are also in U
- This captures the idea that information flows "downward" from inputs to outputs

### Basis:

From the paper:
> "A basis for this topology is made by the collections U_α of the β such that β ≤ α."

The **principal ideal** ↓α = {β | β ≤ α} forms a basis:
- For output α: ↓α = {α} (just itself)
- For tang α: ↓α = all layers that feed into α (tips + original vertices)
- For input α: ↓α = entire connected component from α to outputs

The basis property: U_x ∩ U_y = ⋃_{z ∈ U_x ∩ U_y} U_z
-}

module Neural.Topos.Alexandrov where

open import 1Lab.Prelude
open import 1Lab.HLevel
open import 1Lab.Path
open import 1Lab.Equiv

open import Cat.Base
open import Cat.Instances.Functor
open import Cat.Functor.Base
open import Cat.Site.Base using (Coverage)
open import Cat.Diagram.Limit.Base using (Limit)

open import Order.Base using (Poset)
open import Order.Frame using (is-frame)

open import Data.Nat.Base using (Nat)
open import Data.Power

open import Neural.Topos.Architecture
import Neural.Topos.Poset as NPoset

private variable
  o ℓ : Level

{-|
## Alexandrov-Open Sets (Definitions 1)

A subset U ⊆ X is Alexandrov-open (or simply "open") if it's **downward-closed**
with respect to the ordering ≤.

From the paper:
> "The (lower) Alexandrov topology on X, is made by the subsets U of X such that
> (y ∈ U and x ≤ y) imply x ∈ U."

**Intuition**:
- In terms of paths: if y ∈ U and there's a path from y to x, then x ∈ U
- In terms of information: if y is in region U, all upstream sources of y are in U
-}
module _ (Γ : OrientedGraph o ℓ) where
  open OrientedGraph Γ

  -- Re-use definitions from Poset module
  open NPoset.PosetOfGraph Γ public

  {-|
  ### Power set at our universe level

  Since our ordering is at level (o ⊔ ℓ), we define subsets at that level.
  -}
  Subset : Type (lsuc (o ⊔ ℓ))
  Subset = X-Vertex → Type (o ⊔ ℓ)

  {-|
  ### is-alexandrov-open: Downward-closed subsets

  A subset U is open iff it's closed under going down in the order:
  ∀ x y. (y ∈ U ∧ x ≤ y) → x ∈ U

  In the poset X, this means:
  - If y ∈ U and x ≤ˣ y (there's a morphism y → x), then x ∈ U
  - Equivalently: if y is in U, and x can reach y via a path, then x is in U
  -}
  is-alexandrov-open : Subset → Type (o ⊔ ℓ)
  is-alexandrov-open U = ∀ {x y} → U y → x ≤ˣ y → U x

  {-|
  ### Principal Ideal ↓α

  The principal ideal generated by α is the set of all elements below α:
  ↓α = {β | β ≤ α}

  From the paper:
  > "A basis for this topology is made by the collections U_α of the β such that β ≤ α."

  **Examples** (where arrows point from input to output):
  - ↓(output) = {output} (minimal element)
  - ↓(tang A) = {outputs, ..., tang A} (everything downstream from A)
  - ↓(input) = entire connected component (maximal element reaches everything)
  -}
  principal-ideal : X-Vertex → Subset
  principal-ideal α = λ β → β ≤ˣ α

  -- Notation: ↓_ for principal ideals
  ↓_ : X-Vertex → Subset
  ↓_ = principal-ideal

  {-|
  ### Principal Ideals are Open

  For any vertex α, the principal ideal ↓α is Alexandrov-open.

  **Proof**: Suppose β ∈ ↓α and γ ≤ β. Then:
  - β ∈ ↓α means β ≤ α
  - γ ≤ β is given
  - By transitivity: γ ≤ α
  - Therefore γ ∈ ↓α
  -}
  principal-ideal-is-open : ∀ α → is-alexandrov-open (↓ α)
  principal-ideal-is-open α {x} {y} y∈↓α x≤y = ≤ˣ-trans x≤y y∈↓α

  {-|
  ### Intersection of Principal Ideals

  From the paper:
  > "In fact, consider the intersection U_x ∩ U_x'; if y ≤ x and y ≤ x', we have
  > U_y ⊆ U_x ∩ U_x', then U_x ∩ U_x' = ⋃_{y ∈ U_x ∩ U_x'} U_y."

  The intersection of two principal ideals is a union of principal ideals.
  This is the basis property.

  **Proof**:
  - ↓x ∩ ↓x' = {z | z ≤ x ∧ z ≤ x'}
  - For any y ∈ ↓x ∩ ↓x', we have y ≤ x and y ≤ x'
  - Therefore ↓y ⊆ ↓x ∩ ↓x' (by transitivity)
  - Conversely, if z ∈ ↓x ∩ ↓x', then z ∈ ↓z (by reflexivity)
  - So ↓x ∩ ↓x' = ⋃_{y ∈ ↓x ∩ ↓x'} ↓y
  -}
  principal-ideals-intersection : ∀ x x' →
    (λ z → (↓ x) z × (↓ x') z) ⊆ (λ z → Σ[ y ∈ X-Vertex ] ((↓ x) y × (↓ x') y × (↓ y) z))
    where _⊆_ : Subset → Subset → Type (o ⊔ ℓ)
          U ⊆ V = ∀ z → U z → V z
  principal-ideals-intersection x x' z (z≤x , z≤x') = z , (z≤x , z≤x' , ≤ˣ-refl)

  {-|
  ## The Set Ω(X) of Open Sets

  From the paper:
  > "We note Ω or Ω(X) when there exists a possibility of confusion, the set of
  > (lower) open sets on X."

  Ω(X) is the collection of all Alexandrov-open subsets of X.
  This forms a frame (complete Heyting algebra).
  -}
  Ω-Alexandrov : Type (lsuc (o ⊔ ℓ))
  Ω-Alexandrov = Σ[ U ∈ Subset ] (is-alexandrov-open U)

  -- Empty set is open (vacuously true)
  ∅-open : is-alexandrov-open (λ _ → ⊥)
  ∅-open ()

  -- Whole set X is open (trivially true)
  X-open : is-alexandrov-open (λ _ → ⊤)
  X-open _ _ = tt

  {-|
  ### Union of Open Sets is Open

  If each U_i is open, then ⋃_i U_i is open.

  **Proof**: Suppose y ∈ ⋃_i U_i and x ≤ y.
  - Then y ∈ U_i for some i
  - Since U_i is open and x ≤ y, we have x ∈ U_i
  - Therefore x ∈ ⋃_i U_i
  -}
  union-open : ∀ {I : Type (o ⊔ ℓ)} (Us : I → Subset) →
              (∀ i → is-alexandrov-open (Us i)) →
              is-alexandrov-open (λ x → Σ[ i ∈ I ] (x ∈ Us i))
  union-open Us opens {x} {y} (i , y∈Ui) x≤y = i , opens i y∈Ui x≤y

  {-|
  ### Intersection of Open Sets is Open

  If each U_i is open, then ⋂_i U_i is open.

  **Proof**: Suppose y ∈ ⋂_i U_i and x ≤ y.
  - Then y ∈ U_i for all i
  - Since each U_i is open and x ≤ y, we have x ∈ U_i for all i
  - Therefore x ∈ ⋂_i U_i
  -}
  intersection-open : ∀ {I : Type (o ⊔ ℓ)} (Us : I → ℙ X-Vertex) →
                     (∀ i → is-alexandrov-open (Us i)) →
                     is-alexandrov-open (λ x → ∀ i → x ∈ Us i)
  intersection-open Us opens {x} {y} y∈⋂Ui x≤y = λ i → opens i (y∈⋂Ui i) x≤y

  {-|
  ## Proposition 1.2: Extension of Presheaves to Sheaves

  From the paper:
  > "Proposition 1.2: every presheaf of sets over the category CX can be extended
  > to a sheaf on X for the Alexandrov topology, and this extension is unique up to
  > a unique isomorphism."

  **Construction**: For a presheaf F: CX^op → Sets and an open set U = ⋃_{x ∈ U} ↓x,
  we define:

  ```
  F̃(U) := lim_{x ∈ U} F(x)
  ```

  This is the limit (inverse limit) of F over all x in U.

  **Elements**: An element s ∈ F̃(U) consists of:
  - A family s_x ∈ F(x) for each x ∈ U
  - Compatibility: for any x, x' ∈ U and y ∈ ↓x ∩ ↓x', we have:
    F(x→y)(s_x) = F(x'→y)(s_x')

  **Sheaf condition**: This construction satisfies the sheaf axioms:
  1. **Uniqueness**: If s, s' ∈ F̃(U) agree on a covering, they're equal
  2. **Gluing**: Compatible sections over a covering glue to a global section

  **Uniqueness of extension**: Any two sheaf extensions F̃₁ and F̃₂ of F are
  canonically isomorphic via the isomorphisms F̃_i(↓x) ≅ F(x).
  -}

  module _ {κ : Level} (F : Functor (CX-Category ^op) (Sets κ)) where
    open Functor F

    {-|
    ### Sheaf on U: Limit of F over U

    For an open set U, F̃(U) is defined as the limit of F restricted to
    elements of U.

    **Concrete description**:
    - An element of F̃(U) is a family (s_x)_{x∈U} where s_x ∈ F(x)
    - Subject to: if x ≤ y (i.e., morphism f: y → x), then F(f)(s_y) = s_x
    -}
    postulate
      -- Extension of F to open sets
      F̃ : (U : ℙ X-Vertex) → is-alexandrov-open U → Type κ

      -- For principal ideals, F̃(↓x) ≃ F(x)
      F̃-principal : ∀ (x : X-Vertex) → F̃ (↓ x) (principal-ideal-is-open x) ≃ F₀ x

      {-|
      ### Restriction Maps

      For V ⊆ U (both open), there's a restriction map F̃(U) → F̃(V).
      This is induced by the inclusion of limits.
      -}
      F̃-restrict : ∀ {U V : ℙ X-Vertex}
                   (U-open : is-alexandrov-open U)
                   (V-open : is-alexandrov-open V) →
                   V ⊆ U →
                   F̃ U U-open → F̃ V V-open

      {-|
      ### Sheaf Axiom 1: Uniqueness

      If s, s' ∈ F̃(U) agree on a covering {V_i} of U, then s = s'.

      For Alexandrov topology, a covering of U is any family {V_i} of open sets
      with U = ⋃_i V_i.
      -}
      F̃-unique : ∀ {U : ℙ X-Vertex} {I : Type (o ⊔ ℓ)}
                 (U-open : is-alexandrov-open U)
                 (Vs : I → ℙ X-Vertex)
                 (Vs-open : ∀ i → is-alexandrov-open (Vs i))
                 (cover : ∀ x → x ∈ U → Σ[ i ∈ I ] (x ∈ Vs i))
                 (s s' : F̃ U U-open) →
                 (∀ i (x∈Vi-proof : ∀ x → x ∈ Vs i → x ∈ U) →
                    F̃-restrict U-open (Vs-open i) x∈Vi-proof s ≡
                    F̃-restrict U-open (Vs-open i) x∈Vi-proof s') →
                 s ≡ s'

      {-|
      ### Sheaf Axiom 2: Gluing

      If we have compatible sections s_i ∈ F̃(V_i) for a covering {V_i} of U,
      they glue to a unique section s ∈ F̃(U).

      Compatibility means: for all i, j, the restrictions of s_i and s_j to
      V_i ∩ V_j agree.
      -}
      F̃-glue : ∀ {U : ℙ X-Vertex} {I : Type (o ⊔ ℓ)}
              (U-open : is-alexandrov-open U)
              (Vs : I → ℙ X-Vertex)
              (Vs-open : ∀ i → is-alexandrov-open (Vs i))
              (cover : ∀ x → x ∈ U → Σ[ i ∈ I ] (x ∈ Vs i))
              (ss : ∀ i → F̃ (Vs i) (Vs-open i)) →
              -- Compatibility condition
              (∀ i j → let V-ij-open = intersection-open (λ { true → Vs i ; false → Vs j })
                                                        (λ { true → Vs-open i ; false → Vs-open j })
                      in F̃-restrict (Vs-open i) V-ij-open (λ x (xi , _) → xi) (ss i) ≡
                         F̃-restrict (Vs-open j) V-ij-open (λ x (_ , xj) → xj) (ss j)) →
              F̃ U U-open

  {-|
  ## Corollary: Equivalence Sh(X, Alexandrov) ≃ [CX^op, Sets]

  From the paper:
  > "Corollary. The category C∼ is equivalent to the category Sh(X) of sheaves
  > of X, in the ordinary topological sense, for the (lower) Alexandrov topology."

  And earlier:
  > "C∼ is naturally equivalent to the category of presheaves C∧_X."

  Combining these: **Sh(X, Alexandrov) ≃ [CX^op, Sets]**

  **Proof**:
  1. Every presheaf F on CX extends uniquely to a sheaf F̃ on (X, Alexandrov) (Prop 1.2)
  2. The extension functor [CX^op, Sets] → Sh(X, Alexandrov) is given by F ↦ F̃
  3. This functor is an equivalence because:
     - **Essentially surjective**: Every sheaf G on X restricts to a presheaf G|_CX on CX,
       and G ≅ (G|_CX)~ by the sheaf condition
     - **Fully faithful**: Natural transformations F → G correspond bijectively to
       natural transformations F̃ → G̃ because F̃(↓x) ≅ F(x) for all x

  **Geometric interpretation**:
  - The Alexandrov topology is "natural" for the poset X
  - Sheaves on (X, Alexandrov) are "the same" as presheaves on the category CX
  - The sheaf condition is automatic for Alexandrov: limits over open sets always exist
  -}

  postulate
    alexandrov-presheaf-equivalence : ∀ {κ : Level} →
      -- Sh(X, Alexandrov) ≃ [CX^op, Sets]
      -- This requires defining the sheaf category Sh(X, J) properly
      -- We postulate the equivalence for now
      Type

{-|
## Summary

This module establishes the Alexandrov topology on the poset X:

1. **Alexandrov-open sets**: Downward-closed subsets (y ∈ U ∧ x ≤ y) ⇒ x ∈ U
2. **Principal ideals**: ↓α = {β | β ≤ α} form a basis for the topology
3. **Proposition 1.2**: Presheaves F on CX extend uniquely to sheaves F̃ on (X, Alexandrov)
   - F̃(U) = lim_{x ∈ U} F(x) (limit of F over elements of U)
   - Sheaf axioms: uniqueness and gluing
4. **Corollary**: Sh(X, Alexandrov) ≃ [CX^op, Sets]

**Key insight**: The Alexandrov topology is special because:
- It's the finest topology making all principal ideals open
- It's the "natural" topology for any poset
- Sheaves on (X, Alexandrov) are equivalent to presheaves on X viewed as a category

**Next steps** (in Properties.agda):
- Prove that (X, Alexandrov) is a localic topos
- Establish coherence, sufficiently many points, sub-extensionality
- Connect to the DNN topos Sh[C, J] via Proposition 1.1(iii)
-}
